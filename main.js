(()=>{"use strict";const e=(e,t)=>{e.disabled=!0,e.classList.add(t)},t=(t,r,a)=>{(e=>e.some((e=>!e.validity.valid)))(t)?e(r,a):(r.disabled=!1,r.classList.remove(a))},r=e=>{e.classList.add("popup_opened"),document.addEventListener("keydown",o)},a=e=>{e.classList.remove("popup_opened"),document.removeEventListener("keydown",o)};function o(e){if("Escape"===e.key){const e=document.querySelector(".popup_opened");a(e)}}const n={baseUrl:"https://nomoreparties.co/v1/plus-cohort-23/",headers:{authorization:"a9c8f3fa-c4c8-428a-b274-c9fed27107d1","Content-Type":"application/json; charset=UTF-8"}},s=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),c=fetch(`${n.baseUrl}users/me`,{headers:n.headers}).then((e=>s(e))),l=fetch(`${n.baseUrl}cards`,{headers:n.headers}).then((e=>s(e))),i=document.querySelector("#card-template").content,d=document.querySelector("#cardZoom"),u=document.querySelector("#deleteCard"),m=d.querySelector(".popup__overlay"),_=d.querySelector(".popup__image"),p=document.querySelector(".popup__caption");d.addEventListener("click",(e=>{(e.target.classList.contains("popup__overlay")||e.target.classList.contains("popup__close-button")||e.target.classList.contains("popup__image"))&&a(d)}));const v=(e,t)=>{const a=i.querySelector(".card").cloneNode(!0);a.dataset.cardId=e._id,a.querySelector(".card__delete-button").dataset.cardId=e._id,e.owner._id===t?a.querySelector(".card__delete-button").addEventListener("click",(()=>{u.querySelector(".form__submit").dataset.cardId=e._id,r(u)})):a.querySelector(".card__delete-button").remove();const o=a.querySelector(".card__image");o.src=e.link,o.alt=e.name,o.dataset.userId=e.owner._id,o.addEventListener("click",(()=>(e=>{_.src=e.link,_.alt=e.name,p.textContent=e.name,m.style.backgroundColor="rgba(0, 0, 0, 0.9)",r(d)})(e))),a.querySelector(".card__title").textContent=e.name;const c=a.querySelector(".card__like"),l=a.querySelector(".card__like-counter");return l.textContent=e.likes.length,e.likes.some((e=>e._id===t))&&c.classList.add("card__like_active"),c.addEventListener("click",(t=>{var r;t.target.classList.contains("card__like_active")?(r=e._id,fetch(`${n.baseUrl}cards/likes/${r}`,{method:"DELETE",headers:n.headers}).then((e=>s(e)))).then((e=>{t.target.classList.remove("card__like_active"),l.textContent=e.likes.length})).catch((e=>console.log(e))):(e=>fetch(`${n.baseUrl}cards/likes/${e}`,{method:"PUT",headers:n.headers}).then((e=>s(e))))(e._id).then((e=>{t.target.classList.add("card__like_active"),l.textContent=e.likes.length})).catch((e=>console.log(e)))})),a},y=document.querySelector(".cards"),h=document.querySelector("#profileEdit"),f=document.querySelector("#newCard"),S=document.querySelector("#newAvatar"),b=document.querySelector("#deleteCard"),q=document.querySelector(".profile__avatar"),C=document.querySelector(".profile__name"),L=document.querySelector(".profile__description"),g=h.querySelector(".form"),k=f.querySelector(".form"),E=S.querySelector(".form"),x=g.querySelector("input[name='name']"),$=g.querySelector("input[name='description']"),U=k.querySelector("input[name='title']"),w=k.querySelector("input[name='link']"),A=document.querySelector(".profile__edit-button"),T=E.querySelector("input[name='avatar-link']"),D=document.querySelector(".tg-username"),B=window.Telegram.WebApp;B.expand(),D.textContent=B.initDataUnsafe.user.id;const P={formSelector:".form",inputSelector:".form__input",submitButtonSelector:".form__submit",inactiveButtonClass:"form__submit_disabled",inputErrorClass:"form__input_error",errorClass:"form__input-error_active"},I=e=>{e.addEventListener("click",(t=>{(t.target.classList.contains("popup__overlay")||t.target.classList.contains("popup__close-button"))&&a(e)}))};I(h),I(f),I(S),I(b),A.addEventListener("click",(()=>{x.value=C.textContent,$.value=L.textContent,r(h)})),g.addEventListener("submit",(function(e){var t;e.preventDefault(),e.submitter.textContent="Сохранение...",(t={name:x.value,about:$.value},fetch(`${n.baseUrl}users/me`,{method:"PATCH",headers:n.headers,body:JSON.stringify({name:t.name,about:t.about})}).then((e=>s(e)))).then((e=>{C.textContent=e.name,L.textContent=e.about,a(h)})).catch((e=>console.log(e))).finally((()=>e.submitter.textContent="Сохранить"))})),document.querySelector(".profile__add-button").addEventListener("click",(()=>{r(f)})),k.addEventListener("submit",(function(t){t.preventDefault(),t.submitter.textContent="Сохранение...",e(t.submitter,P.inactiveButtonClass);const r={};r.name=U.value,r.link=w.value,(e=>fetch(`${n.baseUrl}cards`,{method:"POST",headers:n.headers,body:JSON.stringify({name:e.name,link:e.link})}).then((e=>s(e))))(r).then((e=>{k.reset(),a(f),y.prepend(v(e,e.owner._id))})).catch((e=>console.log(e))).finally((()=>{t.submitter.textContent="Сохранить"}))})),document.querySelector(".profile__avatar-overlay").addEventListener("click",(()=>{r(S)})),S.addEventListener("submit",(function(t){var r;t.preventDefault(),t.submitter.textContent="Сохранение...",console.log(T.value),e(t.submitter,P.inactiveButtonClass),(r=T.value,fetch(`${n.baseUrl}users/me/avatar`,{method:"PATCH",headers:n.headers,body:JSON.stringify({avatar:r})}).then((e=>s(e)))).then((e=>{q.src=e.avatar,E.reset(),a(S)})).catch((e=>console.log(e))).finally((()=>t.submitter.textContent="Сохранить"))})),(({formSelector:e,...r})=>{Array.from(document.querySelectorAll(e)).forEach((e=>{e.addEventListener("submit",(e=>{e.preventDefault()})),((e,{inputSelector:r,submitButtonSelector:a,inactiveButtonClass:o,...n})=>{const s=Array.from(e.querySelectorAll(r)),c=e.querySelector(a);t(s,c,o),s.forEach((r=>{r.addEventListener("input",(()=>{((e,t,r)=>{t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?((e,t,r)=>{const a=e.querySelector(`#${t.id}-error`);t.classList.remove(r.inputErrorClass),a.classList.remove(r.errorClass),a.textContent=""})(e,t,r):((e,t,r,a)=>{const o=e.querySelector(`#${t.id}-error`);t.classList.add(a.inputErrorClass),o.classList.add(a.errorClass),o.textContent=r})(e,t,t.validationMessage,r)})(e,r,n),t(s,c,o)}))}))})(e,r)}))})(P),b.addEventListener("submit",(function(e){const t=e.submitter.getAttribute("data-card-id");var r;(r=t,fetch(`${n.baseUrl}cards/${r}`,{method:"DELETE",headers:n.headers}).then((e=>s(e)))).then((()=>{a(b),document.querySelector(`.card[data-card-id="${t}"]`).remove()})).catch((e=>console.log(e)))})),Promise.all([c,l]).then((([e,t])=>{q.src=e.avatar,C.textContent=e.name,L.textContent=e.about,C.dataset.userId=e._id,t.reverse().forEach((t=>y.prepend(v(t,e._id))))})).catch((e=>console.log(e)))})();